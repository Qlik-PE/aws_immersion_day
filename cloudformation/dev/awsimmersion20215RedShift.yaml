AWSTemplateFormatVersion: 2010-09-09
Description: AWS Immersive Day 2021
Resources:
  RedShiftCluster:
    Type: "AWS::Redshift::Cluster"
    Properties:
      AllowVersionUpgrade: "true"
      AutomatedSnapshotRetentionPeriod: "0"
      AvailabilityZone: us-east-1
      ClusterType: single-node
      DBName: testdrive
      MasterUsername: qlik123
      MasterUserPassword: Aws_immersion123
      NodeType: dc2.large
      PubliclyAccessible: "true"
      VpcSecurityGroupIds:
        - !Ref QlikSecurityGroup
      ClusterSubnetGroupName: !Ref RedshiftClusterSubnetGroup
  RedshiftClusterSubnetGroup:
    Type: "AWS::Redshift::ClusterSubnetGroup"
    Properties:
      Description: Redshift Cluster Subnet Group
      SubnetIds:
        - !Ref PrivateSubnet
  RedShiftClusterBucket:
    Type: "AWS::S3::Bucket"
    Properties:
      BucketName: awsimmersionday2021
  RawDataBucketAccessRole:
    Type: "AWS::IAM::Role"
    Properties:
      AssumeRolePolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Principal:
              Service:
                - redshift.amazonaws.com
            Action:
              - "sts:AssumeRole"
  RawDataBucketRolePolicy:
    Type: "AWS::IAM::Policy"
    Properties:
      PolicyName: RawDataBucketRolePolicy
      PolicyDocument:
        Version: 2012-10-17
        Statement:
          - Effect: Allow
            Action: "s3:ListAllMyBuckets"
            Resource: "arn:aws:s3:::*"
          - Effect: Allow
            Action:
              - "s3:Get*"
              - "s3:List*"
            Resource: "*"
          - Effect: Allow
            Action: "cloudwatch:*"
            Resource: "*"
      Roles:
        - !Ref RawDataBucketAccessRole
  PrivateSubnet:
    Type: "AWS::EC2::Subnet"
    Properties:
      VpcId: !Ref VPC
      CidrBlock: 10.0.0.128/25
      Tags:
        - Key: Application
          Value: !Ref "AWS::StackId"
        - Key: Network
          Value: Public
        - Key: Name
          Value: !Join
            - ""
            - - !Ref "AWS::StackName"
              - "-PublicSubnet"
  QlikSecurityGroup:
    Type: "AWS::EC2::SecurityGroup"
    Properties:
      GroupName: !Join
        - ""
        - - !Ref "AWS::StackName"
          - "-QlikSecurityGroup"
      GroupDescription: Default Security Rules for AWS Immersion Day
      VpcId: !Ref VPC
      SecurityGroupIngress:
        - CidrIp: 71.83.219.133/32
          FromPort: 5439
          ToPort: 5439
          IpProtocol: tcp
          Description: john.park@qlik.com - IP
        - SourceSecurityGroupId: !Ref AccessToRedshiftSecurityGroup
          FromPort: 5439
          ToPort: 5439
          IpProtocol: tcp
          Description: Access to redshift
  VPC:
    Type: "AWS::EC2::VPC"
    Properties:
      CidrBlock: 10.0.0.0/24
      EnableDnsSupport: true
      EnableDnsHostnames: true
      Tags:
        - Key: Application
          Value: !Ref "AWS::StackId"
        - Key: Name
          Value: !Join
            - ""
            - - !Ref "AWS::StackName"
              - "-VPC"
  AccessToRedshiftSecurityGroup:
    Type: AWS::EC2::SecurityGroup
    Properties:
      GroupDescription: Access to Redshift access
      VpcId: !Ref VPCID
  InternalSecurityGroupIngress:
    Type: AWS::EC2::SecurityGroupIngress
    Properties:
      IpProtocol: tcp
      FromPort: 0
      ToPort: 65535
      SourceSecurityGroupId: !Ref QlikSecurityGroup
      GroupId: !Ref QlikSecurityGroup
Outputs:
  RedShiftClusterEndpoint:
    Description: Redshift Cluster Endpoint
    Value: !GetAtt RedShiftCluster.Endpoint.Address
  GithubDocumentation:
    Description: URL of Github Documenation
    Value: "https://github.com/Qlik-PE/aws_immersion_day"
